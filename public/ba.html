<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PayPal Billing Agreements v1 Demo</title>
    <style>
      :root { --gap: 12px; --radius: 12px; }
      * { box-sizing: border-box; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        max-width: 760px; margin: 32px auto; padding: 0 16px; color: #111;
      }
      h1 { margin: 0 0 8px; }
      .muted { color: #666; font-size: 0.92rem; }
      .flow code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }

      .box {
        margin-top: 16px;
        border: 1px solid #eaeaea;
        background: #fafafa;
        border-radius: var(--radius);
        padding: 16px;
      }
      .box h3 { margin: 0 0 12px; }
      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: var(--gap);
        align-items: center;
        margin: 8px 0;
      }
      .row.full { grid-template-columns: 1fr; }
      input[type="text"], input[type="number"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc; border-radius: 8px;
      }
      button {
        padding: 10px 16px; border-radius: 10px;
        border: 1px solid #ccc; background: #fff; cursor: pointer;
      }
      button:hover { background: #f6f6f6; }
      .status { min-height: 22px; align-self: center; }
      .ok { color: #227a1a; } .err { color: #a00; }
    </style>
  </head>
  <body>
    <h1>Billing Agreements v1 (Reference Transactions)</h1>
    <p class="muted flow">
      Flow: Create <code>agreement-token</code> → Buyer approves → Create <strong>Billing Agreement (B-/I-)</strong> → Charge using BA ID via Orders v2.
    </p>

    <!-- STEP 1 -->
    <div class="box" id="step1">
      <h3>Step 1 — Create token & approve</h3>
      <div class="row">
        <button id="createToken">Start Billing Agreement</button>
        <div class="status" id="s1"></div>
      </div>
      <p class="muted">A PayPal window will open. After approving, you’ll be redirected with a <code>ba_token</code> in the URL.</p>
    </div>

    <!-- STEP 2 -->
    <div class="box" id="step2">
      <h3>Step 2 — Create the Billing Agreement (get BA ID)</h3>
      <div class="row">
        <input id="tokenId" type="text" placeholder="ba_token" />
        <button id="createAgreement">Create Agreement</button>
      </div>
      <div class="row full">
        <div class="status" id="s2"></div>
      </div>
     

    <!-- STEP 3 -->
    <div class="box" id="step3">
      <h3>Step 3 — Charge using BA ID (Orders v2)</h3>
       <div class="row">
        <input id="agreementId" type="text" placeholder="Agreement ID" />
        <div></div>
      </div>
      <div class="row">
        <input id="amount" type="number" step="0.01" value="10.00" />
        <button id="charge">Charge</button>
      </div>
    </div>  
      <div class="row full">
        <div class="status" id="s3"></div>
      </div>
    </div>

    <p class="muted">Tip: Allow pop-ups when opening the PayPal approval window.</p>

    <script>
      // Helpers
      async function post(url, body) {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        const text = await r.text();
        if (!r.ok) throw new Error(text || r.statusText);
        return text ? JSON.parse(text) : {};
      }
      function qp(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      // Prefill token from common return param names
      (function prefillToken() {
        const val = qp('ba_token') || qp('token') || qp('token_id') || qp('baToken');
        const s1 = document.getElementById('s1');
        if (val) {
          document.getElementById('tokenId').value = val;
          const source =
            qp('ba_token') ? 'ba_token' :
            qp('token') ? 'token' :
            qp('token_id') ? 'token_id' : 'baToken';
          s1.innerHTML = `<span class="ok">Returned with <code>${source}</code>: <code>${val}</code></span>`;
        } else if (qp('approved')) {
          s1.innerHTML = `<span class="ok">Buyer approved — enter the token if not auto-filled.</span>`;
        } else if (qp('canceled')) {
          s1.innerHTML = `<span class="err">Buyer canceled</span>`;
        }
      })();

      // Step 1: create agreement-token
      document.getElementById('createToken').onclick = async () => {
        const s1 = document.getElementById('s1');
        try {
          s1.textContent = 'Creating token...';
          const r = await post('/api/ba/create-token');
          if (r.approve_url) {
            s1.innerHTML = `<span class="ok">Token created. Opening approval...</span>`;
            window.open(r.approve_url, '_blank'); // popup
          } else {
            s1.innerHTML = `<span class="err">No approval URL returned.</span>`;
          }
        } catch (e) {
          s1.innerHTML = `<span class="err">${e.message}</span>`;
        }
      };

      // Step 2: token -> agreement
      document.getElementById('createAgreement').onclick = async () => {
        const s2 = document.getElementById('s2');
        try {
          const token_id = (document.getElementById('tokenId').value || '').trim();
          if (!token_id) throw new Error('token_id is required');
          s2.textContent = 'Creating agreement...';
          const r = await post('/api/ba/create-agreement', { token_id });
          document.getElementById('agreementId').value = r.agreement_id || '';
          s2.innerHTML = `<span class="ok">Agreement ${r.agreement_id} (${r.state})</span>`;
        } catch (e) {
          s2.innerHTML = `<span class="err">${e.message}</span>`;
        }
      };

      // Step 3: charge
      document.getElementById('charge').onclick = async () => {
        const s3 = document.getElementById('s3');
        try {
          const agreement_id = (document.getElementById('agreementId').value || '').trim();
          if (!agreement_id) throw new Error('agreement_id is required');
          const amount = document.getElementById('amount').value || '10.00';
          s3.textContent = 'Creating & capturing order...';
          const r = await post('/api/ba/charge', { agreement_id, amount });
          const cap = r.capture?.purchase_units?.[0]?.payments?.captures?.[0];
          const capId = cap?.id || "(missing)";
          const capStatus = cap?.status || "(unknown)";
          s3.innerHTML = `<span class="ok">Captured transaction id <code>${capId}</code> — status: <code>${capStatus}</code></span>`;
        } catch (e) {
          s3.innerHTML = `<span class="err">${e.message}</span>`;
        }
      };
    </script>
  </body>
</html>
